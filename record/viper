#!/bin/sh

vpid="$HOME/.viper.pid"

start_viper() {
	local path="$1"

	if [ -e "$path" ] 
	then
		printf "'%s' already exist in file system\n" "$path" >&2
		return 1
	fi
 
	if >"$path" >/dev/null 2>&1
	then
		rm -f "$path" 
	else
		printf "cannot write to '%s'\n" "$path"
		return 1
	fi

	test -f "$vpid" && kill -9 `cat "$vpid"` >/dev/null 2>&1
	ffmpeg -video_size 1600x900 \
	       -framerate 100 \
		   -f x11grab \
		   -i :0.0+0,0 \
		   -f pulse \
		   -i alsa_output.pci-0000_00_1b.0.analog-stereo.monitor \
		   -ac 2 \
		   "$path" >/dev/null 2>&1 &

	printf "$!" >"$vpid"
}

kill_viper() {
	if [ -f "$vpid" ]
	then
		kill -9 `cat "$vpid"`
		rm -rf "$vpid"
	fi
}

usage() {
	printf "usage:\n"
	printf "  viper start /path/to/output.ext\n";
	printf "  viper stop\n"
}

case $# in
	1) test "$1" = stop  && kill_viper || usage ;;
	2) test "$1" = start && start_viper "$2" ;;
	*) usage ;;
esac
